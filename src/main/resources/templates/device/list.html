<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>장비 목록</title>
    <link rel="stylesheet" href="/device.css" />
    <link rel="stylesheet" href="/main.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 네비게이션 바 포함 -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    
    <div class="container">
        <div class="device-list-container">
            <div class="title">
                <div class="subject">장비 목록</div>
                <div class="subtitle">학교별, 유형별로 장비를 관리하세요!</div>
            </div>
            <div class="main">
                <div class="filter-container">
                    <form th:action="@{/device/list}" method="get" class="d-flex align-items-center">
                        <select name="schoolId" onchange="this.form.submit()">
                            <option value="">전체 학교</option>
                            <option th:each="school : ${schools}" 
                                    th:value="${school.schoolId}"
                                    th:text="${school.schoolName}"
                                    th:selected="${selectedSchoolId} == ${school.schoolId}">
                            </option>
                        </select>
                        <select name="classroomId" onchange="this.form.submit()">
                            <option value="">전체 교실</option>
                            <option th:each="classroom : ${classrooms}" 
                                    th:value="${classroom.classroomId}"
                                    th:text="${classroom.roomName}"
                                    th:selected="${selectedClassroomId} == ${classroom.classroomId}">
                            </option>
                        </select>
                        <select name="type" onchange="this.form.submit()">
                            <option value="">전체 유형</option>
                            <option th:each="t : ${types}"
                                    th:value="${t}"
                                    th:text="${t}"
                                    th:selected="${selectedType} == ${t}">
                            </option>
                        </select>
                        <input type="hidden" name="page" value="1" />
                        <input type="hidden" name="size" th:value="${pageSize}" />
                    </form>
                    <div class="action-buttons-container">
                        <a href="/device/register" class="btn-primary">
                            <i class="fas fa-plus-circle"></i> 장비 등록
                        </a>
                        <a th:href="@{/device/excel(schoolId=${selectedSchoolId}, type=${selectedType}, classroomId=${selectedClassroomId})}" class="btn-success">
                            <i class="fas fa-file-excel"></i> 엑셀 다운로드
                        </a>
                    </div>
                </div>
                
                <table class="device-table">
                    <thead>
                        <tr>
                            <th>학교</th>
                            <th>고유번호</th>
                            <th>관리번호</th>
                            <th>유형</th>
                            <th>직위</th>
                            <th>담당자</th>
                            <th>제조사</th>
                            <th>모델명</th>
                            <th>제조일자</th>
                            <th>IP주소</th>
                            <th>교실</th>
                            <th>용도</th>
                            <th>세트분류</th>
                            <th>비고</th>
                            <th>불용</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        <th:block th:each="device, iterStat : ${devices}">
                            <!-- 교실 헤더: 이전 장비와 교실명이 다르면 출력 -->
                            <tr th:if="${iterStat.index == 0 or devices[iterStat.index - 1].classroom?.roomName != device.classroom?.roomName}" class="classroom-header">
                                <td colspan="16">
                                    <strong th:text="'교실: ' + ${device.classroom != null ? device.classroom.roomName : '미지정 교실'}"></strong>
                                </td>
                            </tr>
                            <!-- 그룹 헤더: 이전 장비와 세트타입/담당자가 다르면 출력 -->
                            <tr th:if="${iterStat.index == 0 
                                or devices[iterStat.index - 1].classroom?.roomName != device.classroom?.roomName
                                or (devices[iterStat.index - 1].setType != device.setType)
                                or ((devices[iterStat.index - 1].setType == null or devices[iterStat.index - 1].setType == '') 
                                    and (device.setType == null or device.setType == '') 
                                    and (devices[iterStat.index - 1].operator?.name != device.operator?.name))}"
                                class="group-header">
                                <td colspan="16">
                                    <strong th:if="${device.setType != null and device.setType != ''}" th:text="'세트 타입: ' + ${device.setType}"></strong>
                                    <strong th:if="${(device.setType == null or device.setType == '') and device.operator != null and device.operator.name != null}" th:text="'담당자: ' + ${device.operator.name}"></strong>
                                    <strong th:if="${(device.setType == null or device.setType == '') and (device.operator == null or device.operator.name == null)}" th:text="'기타'"></strong>
                                </td>
                            </tr>
                            <!-- 장비 데이터 행 -->
                            <tr th:class="${device.setType != null && device.setType != '' ? 'set-group-item group-item' : (device.operator != null && device.operator.name != null ? 'operator-group-item group-item' : 'group-item')}">
                                <td th:text="${device.school != null && device.school.schoolName != null ? device.school.schoolName : ''}"></td>
                                <td>
                                    <span th:if="${device.uid != null}" th:with="
                                        cate=${device.uid.cate},
                                        schoolCode=${device.school != null ? #numbers.formatInteger(device.school.schoolId, 2) : '00'},
                                        mfgYear=${device.uid.mfgYear != null ? device.uid.mfgYear : 'xx'},
                                        idNumber=${device.uid.idNumber != null ? #numbers.formatInteger(device.uid.idNumber, 4) : '0000'}"
                                        th:text="${cate + schoolCode + mfgYear + idNumber}"></span>
                                </td>
                                <td th:text="${device.manage != null ? (device.manage.manageCate != null ? device.manage.manageCate : '') + (device.manage.year != null ? '-' + device.manage.year : '') + (device.manage.manageNum != null ? '-' + device.manage.manageNum : '') : ''}"></td>
                                <td class="device-type" th:text="${device.type != null ? device.type : ''}"></td>
                                <td th:text="${device.operator != null && device.operator.position != null ? device.operator.position : ''}"></td>
                                <td th:text="${device.operator != null && device.operator.name != null ? device.operator.name : ''}"></td>
                                <td th:text="${device.manufacturer != null ? device.manufacturer : ''}"></td>
                                <td th:text="${device.modelName != null ? device.modelName : ''}"></td>
                                <td th:text="${device.purchaseDate != null ? (#strings.substring(device.purchaseDate, 2, 4) + '.' + #strings.substring(device.purchaseDate, 5, 7) + '.' + #strings.substring(device.purchaseDate, 8, 10)) : ''}"></td>
                                <td class="ip-address" th:text="${device.ipAddress != null ? device.ipAddress : ''}"></td>
                                <td th:text="${device.classroom != null && device.classroom.roomName != null ? device.classroom.roomName : ''}"></td>
                                <td th:text="${device.purpose != null ? device.purpose : ''}"></td>
                                <td th:text="${device.setType != null ? device.setType : ''}"></td>
                                <td th:text="${device.note != null ? device.note : ''}"></td>
                                <td th:text="${device.unused != null && device.unused ? 'O' : 'X'}"></td>
                                <td>
                                    <div class="action-buttons">
                                        <a th:href="@{/device/modify/{id}(id=${device.deviceId})}" class="btn-warning" title="수정">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form th:action="@{/device/remove}" method="post" style="display: inline;">
                                            <input type="hidden" name="device_id" th:value="${device.deviceId}">
                                            <button type="submit" class="btn-danger" onclick="return confirm('정말 삭제하시겠습니까?')" title="삭제">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        </th:block>
                    </tbody>
                </table>
                
                <!-- 페이징 네비게이션 -->
                <nav th:if="${totalPages > 1}">
                    <ul class="pagination">
                        <li th:classappend="${startPage == 1} ? 'disabled'">
                            <a th:if="${startPage != 1}" 
                               th:href="@{/device/list(
                                   page=${startPage - 1},
                                   schoolId=${selectedSchoolId != null ? selectedSchoolId : null},
                                   type=${selectedType != null and selectedType != '' ? selectedType : null},
                                   classroomId=${selectedClassroomId != null ? selectedClassroomId : null}
                               )}"
                               th:text="'이전'"></a>
                            <a th:if="${startPage == 1}" href="javascript:void(0);" th:text="'이전'"></a>
                        </li>
                        <li th:each="pageNum : ${#numbers.sequence(startPage, endPage)}">
                            <a th:href="@{/device/list(
                                   page=${pageNum},
                                   schoolId=${selectedSchoolId != null ? selectedSchoolId : null},
                                   type=${selectedType != null and selectedType != '' ? selectedType : null},
                                   classroomId=${selectedClassroomId != null ? selectedClassroomId : null}
                               )}"
                               th:text="${pageNum}"
                               th:classappend="${pageNum == currentPage} ? 'active'"></a>
                        </li>
                        <li th:classappend="${endPage == totalPages} ? 'disabled'">
                            <a th:if="${endPage != totalPages}" 
                               th:href="@{/device/list(
                                   page=${endPage + 1},
                                   schoolId=${selectedSchoolId != null ? selectedSchoolId : null},
                                   type=${selectedType != null and selectedType != '' ? selectedType : null},
                                   classroomId=${selectedClassroomId != null ? selectedClassroomId : null}
                               )}"
                               th:text="'다음'"></a>
                            <a th:if="${endPage == totalPages}" href="javascript:void(0);" th:text="'다음'"></a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- 푸터 포함 -->
    <div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html> 